worker_processes 4;

events { worker_connections 1024; }

http {
  include /etc/nginx/mime.types;
  sendfile on;

  upstream rails_app {
    least_conn;
    server application:3000;
  }

  # Фронт
  server {
    listen 80;
    server_name ommo-contract.ru www.ommo-contract.ru;
    return 301 https://$host$request_uri;
  }

  server {
      listen 443 ssl http2;
      server_name ommo-contract.ru www.ommo-contract.ru;

      root /usr/share/nginx/html;
      index index.html;

      ssl_certificate /etc/ssl/certs/ommo-contract.crt;       # ваш сертификат
      ssl_certificate_key /etc/ssl/private/ommo-contract.key; # ваш ключ
      ssl_protocols TLSv1.2 TLSv1.3;
      ssl_ciphers HIGH:!aNULL:!MD5;

      location / {
          try_files $uri /index.html;
      }
    }

  # API на другом порту
  server {
    listen 8080;

    location / {
      proxy_pass http://rails_app;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_redirect off;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }
  }
}

# worker_processes auto;
#
# events {
#     worker_connections 1024;
# }
#
# http {
#     include       /etc/nginx/mime.types;
#     default_type  application/octet-stream;
#     sendfile      on;
#     tcp_nopush    on;
#     tcp_nodelay   on;
#     keepalive_timeout 65;
#     server_tokens off;
#
#     # --- Gzip сжатие для фронта ---
#     gzip on;
#     gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
#     gzip_min_length 256;
#
#     upstream rails_app {
#         least_conn;
#         server 127.0.0.1:3000;  # Rails внутри сервера
#     }
#
#     # --- HTTP редирект на HTTPS ---
#     server {
#         listen 80;
#         server_name ommo-contract.ru www.ommo-contract.ru;
#         return 301 https://$host$request_uri;
#     }
#
#     # --- HTTPS фронт + API прокси ---
#     server {
#         listen 443 ssl http2;
#         server_name ommo-contract.ru www.ommo-contract.ru;
#
#         root /usr/share/nginx/html;
#         index index.html index.htm;
#
#         # SSL
#         ssl_certificate /etc/ssl/certs/ommo-contract.crt;
#         ssl_certificate_key /etc/ssl/private/ommo-contract.key;
#         ssl_protocols TLSv1.2 TLSv1.3;
#         ssl_prefer_server_ciphers on;
#         ssl_ciphers 'EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH';
#         ssl_session_cache shared:SSL:10m;
#         ssl_session_timeout 10m;
#
#         # Безопасность
#         add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
#         add_header X-Frame-Options SAMEORIGIN;
#         add_header X-Content-Type-Options nosniff;
#
#         # Фронт
#         location / {
#             try_files $uri /index.html;
#         }
#
#         # API через прокси
#         location /api/ {
#             proxy_pass http://rails_app;
#             proxy_http_version 1.1;
#             proxy_set_header Connection "";
#             proxy_redirect off;
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $scheme;
#         }
#
#         # Кэширование статики
#         location ~* \.(?:ico|css|js|gif|jpe?g|png|woff2?|eot|ttf|svg)$ {
#             expires 1M;
#             add_header Cache-Control "public";
#         }
#     }
# }
